<!DOCTYPE html>
<h1 data-cy="page-header">Harvest Report</h1>
<div id ="First-vue" v-cloak>
    <input type="text" v-model="header">
    <h2> {{ header ? header : "Mock Harvest Report"}} </h2>
    <ul>
        <li v-for="name in names">{{ name }}</li>
    </ul>

    <label for="start-date">Start Date:</label>
    <input data-cy="start-date" type ="date" id="start-date" min ="2014-01-01" :max ="endDate" v-model="startDate" />
    <br>

    <label for="end-date">End Date:</label>
    <input data-cy="end-date" type ="date" id="end-date" :min ="startDate" max ="2020-01-01" v-model="endDate" />
`   <br>

    <label for = "Crops"> Crops: </label>
    <select id="Crops" v-model="selectedCrop" >
        <optgroup data-cy = "crop-dropdown" label="Crops">
            <option v-for="crop in cropNames" :key = "crop"> {{ crop }} </option>
        </optgroup>
      </select>

      <br>
      <label for = "Areas "> Areas:</label>
      <select id="Areas" v-model="selectedArea" >
        <optgroup label="Areas">
            <option v-for="area in areas"> {{ area }} </option>
        </optgroup>
      </select>

      <br>

      
      <button @click="generateReport">Generate Report </button>
    <br>
      <div v-if="harvestReportRows.length > 0">
    <table border = "1">
        <tr>
            <th> Row </th>
            <th> Date </th>
            <th> Area </th>
            <th> Crop </th>
            <th> Yield </th>
            <th> Units </th>
        </tr>
        <tr v-for = "(row, index) in harvestReportRows":key = "index">
            <td> {{index + 1}}</td>
            <td> {{row.date}} </td>
            <td> {{row.area}} </td>
            <td> {{row.crop}} </td>
            <td> {{row.yield}} </td>
            <td> {{row.units}} </td>
        </tr>

    </table>
</div>
<p v-else> No Matching Records</p>
</div>

<script>
var firstVue = new Vue({
    created() {
        console.log("HarvestReport Vue instance created!");
        getIDToCropMap()
        .then((theMap) => {
        this.idToCropMap = theMap;
        console.log("Map fetched successfully", this.idToCropMap);

        })
        .catch((error) => {
            console.error("Error fetching the map", error);
        });
    },
el: "#First-vue",
data: {
    header: "My Sample Harvest Report",
    startDate: "2020-05-05",
    endDate: "2020-05-15",
    selectedCrop: "",
    selectedArea: "",
    farm: " ",
    user: " ",
    language: " ",
    names: [
        "Joe",
        "Arun",
        "Ouwen",
        "Anh",
        "Sue",
    ],
    crops: ["Broccoli", "Kale", "Peas"],
    areas: ["North Field", "South Field", "Greenhouse"],
    harvestLogs: [],
    idToCropMap: new Map(),
    harvestLogsArray: []
},
    computed: {
        cropNames() {
            console.log("Map fetched successfully");
            return Array.from(this.idToCropMap.values());
            
        },
        harvestReportRows() {
            let tableRows = []
            for (let log of this.harvestLogsArray) {

                if (this.selectedCrop && cropName !== this.selectedCrop) {
            continue; 
        }
        let area = log.area ? log.area[0].name : "Unknown Area"; 
        let harvestQuantity = log.quantity.find(q => q.label === "harvest");
        let yieldAmount = harvestQuantity ? harvestQuantity.value : "N/A";
        let units = harvestQuantity ? harvestQuantity.units : "N/A";
        let formattedDate = dayjs.unix(log.timestamp).format('YYYY-MM-DD');
        
        let cropName = this.idToCropMap.get(log.data.crop_tid) || "Unknown Crop";
                let tableRow = {
                    date: formattedDate,
                    area: area,     
                    crop: cropName,    
                    yield: yieldAmount,     
                    units: units
                }
                tableRows.push(tableRow);
            }
            return tableRows;
        }
    },
    methods: {
    generateReport: function() {
        let startDateUnix = dayjs(this.startDate).unix();
        let endDateUnix = dayjs(this.endDate).unix();
        console.log('Start Timestamp', startDateUnix);
        console.log('End Timestamp', endDateUnix);
        const endpoint = `/log.json?type=farm_harvest&timestamp[ge]=${startDateUnix}&timestamp[le]=${endDateUnix}`;
        
        getAllPages(endpoint, this.harvestLogsArray)
        .then((pages) => {
            this.harvestLogsArray = pages;
            console.log("Harvest logs successfully fetched", this.harvestLogsArray);
        })
        .catch((error) => {
            console.error('Error fetching harvest logs', error);
        })
        axios.get('/farm.json')  // this line sends the request.
.then((response) => {
	// Block A:
	// Code here executes when the response is received.
	// response is an Object created from the “Response Body” JSON.
    this.farm = response.data.name;
        this.user = response.data.user.name;
        this.language = response.data.language;
})
.catch((error) => {
	// Block B: 
	// Code here executes if an error occurs processing the request.
	// error is an Object describing the error that occurred.
    console.log(error);
})
// Block C: 
	// Code here runs immediately after the request is sent,
	// which will be before the code in then() or catch(),
	// and before the response is received.
        this.harvestLogs.push({
            date: '2018-05-01',
            area: 'Orion-3',
            crop: 'kale',
            yield: '100',
            units: 'kg',
            farm: this.farm,
            user: this.user,
            language: this.language
        });
    }
}
});
Vue.config.devtools = true;
</script>